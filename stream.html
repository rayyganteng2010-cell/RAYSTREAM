<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RayStream Player</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --bg-panel: #0f0f11;
      --primary: #6366f1;
      --anime-color: #f59e0b;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --wa-color: #25D366;
      --surface: #1e1e22;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Outfit', sans-serif; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-panel);
      color: var(--text-main);
      overflow-x: hidden;
      padding-bottom: 40px;
    }

    /* --- HEADER --- */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 50;
      display: flex; align-items: center; gap: 15px;
      padding: 15px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
      pointer-events: none; 
    }
    
    .header-btn {
      pointer-events: auto;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: white;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .header-title {
      font-size: 0.9rem; font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      flex: 1; opacity: 1; color: #fff;
    }

    /* --- PLAYER AREA --- */
    .player-container {
      position: sticky; top: 0; z-index: 40;
      width: 100%;
      background: #000;
      padding-top: 56.25%; /* 16:9 */
    }

    .player-frame {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      border: none;
      z-index: 10; 
    }

    .fs-btn-overlay {
        position: absolute; bottom: 10px; right: 10px;
        background: rgba(0,0,0,0.6); color: white;
        padding: 8px; border-radius: 8px;
        cursor: pointer; z-index: 20;
        border: 1px solid rgba(255,255,255,0.2);
        display: flex; align-items: center; justify-content: center;
        opacity: 0.8;
    }

    /* --- CONTENT BODY --- */
    .content-body {
      padding: 20px;
      background: var(--bg-panel);
      position: relative; 
      z-index: 45; 
      margin-top: 0; 
      border-top: 1px solid rgba(255,255,255,0.05);
      min-height: 400px;
    }

    .ep-title {
      font-size: 1.1rem; font-weight: 700; line-height: 1.4; margin-bottom: 8px;
    }

    .ep-meta {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.75rem; color: var(--text-muted); margin-bottom: 20px;
    }

    .badge {
      padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 0.7rem;
    }
    .badge-src { background: var(--primary); color: #fff; }
    .badge-anime { background: var(--anime-color); color: #000; }

    /* Navigasi */
    .nav-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
    }
    .btn-nav {
      background: var(--surface); color: #fff; border: 1px solid rgba(255,255,255,0.05);
      padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-nav:disabled { opacity: 0.5; pointer-events: none; }

    /* WA Button */
    .btn-wa {
      background: var(--wa-color); color: #fff;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%; padding: 14px; border-radius: 16px;
      font-weight: 700; text-decoration: none; margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.2);
    }

    /* --- SERVER TRIGGER BTN --- */
    .server-trigger-btn {
      width: 100%;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 15px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
      margin-bottom: 20px;
      transition: 0.2s;
    }
    .server-trigger-btn:active { background: #2a2a30; }
    
    .st-left { display: flex; flex-direction: column; gap: 4px; }
    .st-label { font-size: 0.7rem; color: var(--text-muted); }
    .st-value { font-weight: 700; color: var(--primary); text-transform: uppercase; }
    .anime-mode .st-value { color: var(--anime-color); }

    /* --- SERVER MODAL --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      display: none;
      align-items: flex-end;
      backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }

    .modal-content {
      background: #18181b;
      width: 100%;
      max-height: 70vh;
      border-radius: 24px 24px 0 0;
      padding: 20px;
      overflow-y: auto;
      animation: slideUp 0.3s;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; }
    
    .srv-group { margin-bottom: 15px; }
    .srv-group-title { 
      font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 700; 
      padding-left: 5px; border-left: 3px solid var(--primary);
    }
    .anime-mode .srv-group-title { border-color: var(--anime-color); }

    .srv-list-modern {
      display: grid; grid-template-columns: 1fr; gap: 8px;
    }
    
    .btn-srv-modern {
      background: rgba(255,255,255,0.05);
      padding: 12px 15px;
      border-radius: 12px;
      color: #fff;
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex; justify-content: space-between; align-items: center;
    }
    .btn-srv-modern:hover { background: rgba(255,255,255,0.1); }
    .btn-srv-modern.active {
      background: rgba(99, 102, 241, 0.15);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 700;
    }
    .anime-mode .btn-srv-modern.active {
      background: rgba(245, 158, 11, 0.15);
      border-color: var(--anime-color);
      color: var(--anime-color);
    }

    /* Download List */
    .dl-section { display: none; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
    .dl-item { background: #18181b; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
    .dl-res { font-size: 0.75rem; font-weight: 700; color:#fff; margin-bottom:5px; }
    .dl-links a { 
        display: inline-block; padding: 4px 8px; background: rgba(255,255,255,0.1); 
        color: #fff; font-size: 0.7rem; border-radius: 4px; text-decoration: none; margin-right: 5px; margin-bottom: 5px;
    }

    #toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #333; padding: 10px 20px; border-radius: 30px; color: #fff;
      font-size: 0.8rem; z-index: 200; opacity: 0; transition: 0.3s; pointer-events: none;
      white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<header>
  <div class="header-btn" onclick="history.back()">
    <i data-lucide="arrow-left" width="20"></i>
  </div>
  <div class="header-title" id="headerTitle">RayStream</div>
</header>

<div class="player-container">
    <iframe id="iframePlayer" class="player-frame" src="" 
        sandbox="allow-scripts allow-same-origin allow-presentation allow-forms"
        referrerpolicy="no-referrer"
        allowfullscreen="true" 
        allow="autoplay; fullscreen; encrypted-media; picture-in-picture">
    </iframe>

    <div class="fs-btn-overlay" onclick="toggleFullScreen()">
        <i data-lucide="maximize" width="18"></i>
    </div>
</div>

<div class="content-body" id="bodyContent">
    
    <div class="ep-title" id="epTitle">Memuat...</div>
    <div class="ep-meta">
        <span class="badge badge-src" id="srcBadge">SOURCE</span>
        <span id="dateInfo">Loading...</span>
    </div>

    <div class="nav-row">
        <button id="btnPrev" class="btn-nav" disabled>
            <i data-lucide="skip-back" width="18"></i> Prev
        </button>
        <button id="btnNext" class="btn-nav" disabled>
            Next <i data-lucide="skip-forward" width="18"></i>
        </button>
    </div>

    <div class="server-trigger-btn" onclick="openServerModal()">
        <div class="st-left">
            <span class="st-label">SERVER STREAMING</span>
            <span class="st-value" id="currentServerName">AUTO PILIH</span>
        </div>
        <i data-lucide="chevron-up" width="20" style="color:var(--text-muted)"></i>
    </div>

    <a href="https://whatsapp.com/channel/0029Vb6kx8FFi8xZBhjm2g0m" target="_blank" class="btn-wa">
        <i data-lucide="message-circle" width="20" fill="white"></i> Gabung Saluran WA
    </a>

    <div id="dlToggleArea" style="text-align:center; margin-top:10px; display:none;" onclick="toggleDl()">
        <span style="font-size:0.8rem; color:#aaa; text-decoration:underline; cursor:pointer;">
            <i data-lucide="download" width="12"></i> Lihat Link Download
        </span>
    </div>

    <div class="dl-section" id="dlSection">
        <div id="dlContainer"></div>
    </div>
</div>

<div class="modal-overlay" id="serverModal" onclick="closeServerModal(event)">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Pilih Server / Resolusi</div>
            <i data-lucide="x" width="24" onclick="closeServerModal(null)" style="cursor:pointer"></i>
        </div>
        <div id="serverListContainer">
            <p style="text-align:center; color:#666">Memuat server...</p>
        </div>
    </div>
</div>

<div id="toast">Notifikasi</div>

<script>
    // ===================================
    // CONFIG
    // ===================================
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    const API_ANIME   = "https://www.sankavollerei.com/anime/samehadaku"; 

    // Helper Proxy
    async function smartFetch(url) {
        const proxies = [
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
        ];
        try { const res = await fetch(url); if(res.ok) return await res.json(); } catch(e){}
        for (const p of proxies) {
            try { const res = await fetch(p(url)); if(res.ok) return await res.json(); } catch(e){}
        }
        throw new Error("Gagal mengambil data (CORS/Network)");
    }

    const urlParams = new URLSearchParams(window.location.search);
    const donghuaUrl = urlParams.get('url');
    const animeId = urlParams.get('id'); 
    let source = urlParams.get('source');

    if (!source) {
        if (animeId) source = 'anime';
        else if (donghuaUrl) source = 'donghua';
    }

    // ===================================
    // MAIN LOAD
    // ===================================
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        setupSourceUI();

        if (source === 'anime' && animeId) {
            loadAnime(animeId);
        } else if (source === 'donghua' && donghuaUrl) {
            loadDonghua(donghuaUrl);
        } else {
            document.getElementById('epTitle').innerText = "Link Tidak Valid";
        }
    });

    function setupSourceUI() {
        const badge = document.getElementById('srcBadge');
        if (source === 'anime') {
            badge.innerText = "ANIME";
            badge.className = "badge badge-anime";
            document.body.classList.add('anime-mode');
        } else {
            badge.innerText = "DONGHUA";
            badge.className = "badge badge-src";
        }
    }

    // ===================================
    // LOGIC ANIME
    // ===================================
    async function loadAnime(id) {
        try {
            const cleanID = id.replace(/\/$/, '').split('/').pop();
            const json = await smartFetch(`${API_ANIME}/episode/${cleanID}`);
            const data = json.data;

            if (!data) throw new Error("Data Episode tidak ditemukan");

            // Info
            document.getElementById('epTitle').innerText = data.title;
            document.getElementById('headerTitle').innerText = data.title;
            document.getElementById('dateInfo').innerText = data.releasedOn || "Anime";

            // Server Logic (From Download List -> Streaming)
            const servers = [];
            // Prioritas Resolusi: 720p -> 480p -> 1080p -> 360p
            const priority = ['720p', '480p', '1080p', '360p'];

            // Kita struktur ulang data biar enak di render di modal
            // Format: { "720p": [ {name: "Gofile", url: "..."} ] }
            const groupedServers = {};

            if (data.downloads && Array.isArray(data.downloads)) {
                data.downloads.forEach(ext => {
                    if(ext.qualities) {
                        ext.qualities.forEach(q => {
                            const res = q.title.trim();
                            if(!groupedServers[res]) groupedServers[res] = [];

                            if(q.urls) {
                                q.urls.forEach(u => {
                                    groupedServers[res].push({
                                        name: u.title,
                                        url: u.url
                                    });
                                    
                                    // Masukin ke flat list buat auto play
                                    servers.push({
                                        res: res,
                                        name: u.title,
                                        url: u.url
                                    });
                                });
                            }
                        });
                    }
                });
            }

            // Auto Play Logic: Cari stream URL default atau yang pertama dari list
            if (data.defaultStreamingUrl) {
                playVideo(data.defaultStreamingUrl, "DEFAULT STREAM");
            } else if (servers.length > 0) {
                // Cari resolusi terbaik yang ada
                let best = servers[0];
                for(let p of priority) {
                    const found = servers.find(s => s.res.includes(p));
                    if(found) { best = found; break; }
                }
                playVideo(best.url, `${best.name} ${best.res}`);
            } else {
                showToast("Tidak ada server tersedia");
            }

            // Render Server Modal
            renderGroupedServers(groupedServers);

            // Nav
            const nav = data.navigation;
            if (nav && nav.prev) {
                const prevId = nav.prev.replace(/\/$/, '').split('/').pop(); // Extract ID
                const btn = document.getElementById('btnPrev');
                btn.disabled = false;
                btn.onclick = () => window.location.href = `stream.html?id=${prevId}&source=anime`;
            }
             // Samehadaku API prev/next kadang null, handle manual kalau ada href
            if(data.prevEpisode) {
                const btn = document.getElementById('btnPrev');
                btn.disabled = false;
                btn.onclick = () => window.location.href = `stream.html?id=${data.prevEpisode.episodeId}&source=anime`;
            }
            if(data.nextEpisode) {
                const btn = document.getElementById('btnNext');
                btn.disabled = false;
                btn.onclick = () => window.location.href = `stream.html?id=${data.nextEpisode.episodeId}&source=anime`;
            }

            // Downloads (Kalau ada list terpisah, render)
            if(data.downloadUrl && data.downloadUrl.formats) {
                document.getElementById('dlToggleArea').style.display = 'block';
                renderAnimeDownloads(data.downloadUrl);
            }

            saveHistory(data.title, cleanID, 'anime');

        } catch (e) {
            console.error(e);
            document.getElementById('epTitle').innerText = "Error: " + e.message;
            showToast("Gagal memuat anime");
        }
    }

    // ===================================
    // LOGIC DONGHUA
    // ===================================
    async function loadDonghua(url) {
        try {
            const res = await fetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(url)}`);
            const json = await res.json();
            
            if (!json || !json.streaming) throw new Error("Data Error");

            document.getElementById('epTitle').innerText = json.episode;
            document.getElementById('headerTitle').innerText = json.episode;
            
            // Server Grouping (Mocking Donghua servers as "HD")
            const servers = json.streaming.servers || [];
            const grouped = { "HD SERVER": [] };
            
            servers.forEach(s => {
                grouped["HD SERVER"].push({ name: s.name, url: s.url });
            });

            // Default Play
            let defaultSrv = servers.find(s => s.name.toLowerCase().includes('premium')) || servers[0];
            if (defaultSrv) playVideo(defaultSrv.url, defaultSrv.name);

            renderGroupedServers(grouped);

            // Nav
            const nav = json.navigation;
            const prev = document.getElementById('btnPrev');
            const next = document.getElementById('btnNext');
            if (nav.previous_episode?.anichinUrl) {
                prev.disabled = false;
                prev.onclick = () => window.location.href = `stream.html?url=${encodeURIComponent(nav.previous_episode.anichinUrl)}&source=donghua`;
            }
            if (nav.next_episode?.anichinUrl) {
                next.disabled = false;
                next.onclick = () => window.location.href = `stream.html?url=${encodeURIComponent(nav.next_episode.anichinUrl)}&source=donghua`;
            }

            if(json.download_url) {
                document.getElementById('dlToggleArea').style.display = 'block';
                renderDonghuaDownloads(json.download_url);
            }

            saveHistory(json.episode, url, 'donghua');

        } catch (e) {
            document.getElementById('epTitle').innerText = "Error: " + e.message;
        }
    }

    // ===================================
    // RENDERERS
    // ===================================
    function renderGroupedServers(groupedData) {
        const container = document.getElementById('serverListContainer');
        container.innerHTML = "";

        if(Object.keys(groupedData).length === 0) {
            container.innerHTML = "<p style='text-align:center;color:#666'>Tidak ada server.</p>";
            return;
        }

        // Loop setiap Resolusi
        for (const [res, list] of Object.entries(groupedData)) {
            if(list.length === 0) continue;

            const group = document.createElement('div');
            group.className = "srv-group";
            group.innerHTML = `<div class="srv-group-title">${res.toUpperCase()}</div>`;
            
            const listDiv = document.createElement('div');
            listDiv.className = "srv-list-modern";

            list.forEach(srv => {
                const btn = document.createElement('div');
                btn.className = "btn-srv-modern";
                // Bersihin nama server
                const clean = srv.name.replace(/\[.*?\]/g, '').trim();
                btn.innerHTML = `<span>${clean}</span> <i data-lucide="play-circle" width="16"></i>`;
                
                btn.onclick = () => {
                    playVideo(srv.url, `${clean} (${res})`);
                    closeServerModal(null);
                    // Reset active
                    document.querySelectorAll('.btn-srv-modern').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                listDiv.appendChild(btn);
            });

            group.appendChild(listDiv);
            container.appendChild(group);
        }
        lucide.createIcons();
    }

    function playVideo(url, name) {
        const iframe = document.getElementById('iframePlayer');
        iframe.src = 'about:blank';
        setTimeout(() => { iframe.src = url; }, 50);
        
        document.getElementById('currentServerName').innerText = name.toUpperCase();
        showToast("Memutar: " + name);
    }

    // Modal
    function openServerModal() { document.getElementById('serverModal').classList.add('active'); }
    function closeServerModal(e) { 
        if(e && e.target !== e.currentTarget) return; 
        document.getElementById('serverModal').classList.remove('active'); 
    }

    // Downloads
    function renderAnimeDownloads(data) {
        const box = document.getElementById('dlContainer');
        if (!data || !data.formats) return;
        let html = "";
        data.formats.forEach(f => {
            html += `<div class="dl-item"><div class="dl-res">${f.title}</div><div class="dl-links">`;
            if (f.qualities) {
                f.qualities.forEach(q => {
                    (q.urls || []).forEach(u => {
                        html += `<a href="${u.url}" target="_blank">${q.title} (${u.title})</a>`;
                    });
                });
            }
            html += `</div></div>`;
        });
        box.innerHTML = html;
    }

    function renderDonghuaDownloads(urls) {
        const box = document.getElementById('dlContainer');
        let html = "";
        for (let [k, v] of Object.entries(urls)) {
            let res = k.replace('download_url_', '').toUpperCase();
            html += `<div class="dl-item"><div class="dl-res">${res}</div><div class="dl-links">`;
            for (let [prov, link] of Object.entries(v)) {
                html += `<a href="${link}" target="_blank">${prov}</a>`;
            }
            html += `</div></div>`;
        }
        box.innerHTML = html;
    }

    function toggleFullScreen() {
        const elem = document.getElementById('iframePlayer');
        if (elem.requestFullscreen) { elem.requestFullscreen(); }
        else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
        else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
    }

    function toggleDl() {
        const el = document.getElementById('dlSection');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function saveHistory(title, url, src) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== url);
        hist.unshift({ title, url, source: src, date: new Date().toLocaleDateString() });
        localStorage.setItem('my_history', JSON.stringify(hist.slice(0, 20)));
    }
</script>
</body>
</html>
