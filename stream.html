<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RayStream Player</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --bg-dark: #000000;
      --bg-panel: #121212;
      --primary: #6366f1;
      --accent: #8b5cf6;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --wa-color: #25D366;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Outfit', sans-serif; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-panel);
      color: var(--text-main);
      overflow-x: hidden;
      padding-bottom: 50px;
    }

    /* --- APP HEADER --- */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 15px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
      pointer-events: none; /* Klik tembus ke video */
    }
    
    .header-btn {
      pointer-events: auto;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(5px);
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: white;
    }

    .header-title {
      font-size: 0.9rem; font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 60%;
      opacity: 0; transition: 0.3s;
    }

    /* --- VIDEO PLAYER AREA --- */
    .player-wrapper {
      position: relative;
      width: 100%;
      background: #000;
      /* Aspek Rasio 16:9 */
      padding-top: 56.25%; 
      overflow: hidden;
    }

    .player-frame {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      border: none; z-index: 1;
    }

    /* Layer Gesture & Overlay (Agar terasa seperti aplikasi) */
    .gesture-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 2;
      display: flex;
    }
    .gesture-zone { flex: 1; height: 100%; }

    /* Animasi Tap 2x */
    .tap-feedback {
      position: absolute; top: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.6); color: white;
      padding: 10px 20px; border-radius: 30px;
      font-size: 0.8rem; font-weight: 700;
      display: flex; align-items: center; gap: 5px;
      opacity: 0; pointer-events: none; z-index: 10;
    }
    .tap-left { left: 20%; }
    .tap-right { left: 80%; }
    @keyframes ripple { 
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
    }

    /* --- CONTROLS & INFO --- */
    .content-body {
      padding: 20px;
      background: var(--bg-panel);
      position: relative; z-index: 50;
      border-radius: 20px 20px 0 0;
      margin-top: -15px; /* Overlap dikit ke player */
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }

    /* Navigasi Episode */
    .nav-controls {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .nav-btn {
      background: #1e1e2e; color: var(--text-main);
      padding: 10px 20px; border-radius: 12px;
      font-size: 0.85rem; font-weight: 600;
      border: 1px solid rgba(255,255,255,0.05);
      display: flex; align-items: center; gap: 8px;
      cursor: pointer;
    }
    .nav-btn:disabled { opacity: 0.3; pointer-events: none; }

    /* Judul Utama (Hidden by default, shown here) */
    .main-info { margin-bottom: 20px; }
    .series-title { 
      font-size: 1.2rem; font-weight: 700; line-height: 1.3; margin-bottom: 5px; 
    }
    .meta-tags { display: flex; gap: 8px; font-size: 0.75rem; color: var(--text-muted); }

    /* --- WA BUTTON --- */
    .wa-btn {
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%;
      background: var(--wa-color);
      color: #fff;
      font-weight: 700; font-size: 0.95rem;
      padding: 14px; border-radius: 16px;
      text-decoration: none;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      transition: 0.2s;
    }
    .wa-btn:active { transform: scale(0.98); }

    /* --- SERVER BOX (DROPDOWN) --- */
    .server-box {
      background: #1e1e2e;
      border-radius: 16px;
      padding: 5px;
      border: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 20px;
    }

    .server-header {
      padding: 15px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    .server-current {
      font-weight: 600; color: var(--primary);
      text-transform: uppercase; letter-spacing: 1px;
    }

    .server-list {
      display: none; /* Hidden by default */
      padding: 0 10px 15px 10px;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      animation: slideDown 0.3s ease;
    }
    .server-list.show { display: grid; }

    .srv-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 10px; border-radius: 10px;
      color: #ccc; font-size: 0.8rem; font-weight: 500;
      cursor: pointer; text-align: center;
      text-transform: uppercase;
    }
    .srv-item:hover { background: rgba(255,255,255,0.1); }
    .srv-item.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* --- DOWNLOAD --- */
    .dl-toggle {
      text-align: center; color: var(--text-muted); font-size: 0.85rem;
      padding: 15px; cursor: pointer; text-decoration: underline;
    }
    .dl-area { display: none; padding: 10px; background: #1e1e2e; border-radius: 16px; margin-top: 10px;}
    .dl-link { 
      display: block; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); 
      color: var(--text-main); text-decoration: none; font-size: 0.85rem;
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95); padding: 12px 24px; border-radius: 30px;
      color: white; font-size: 0.9rem; z-index: 200;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .toast.show { opacity: 1; bottom: 50px; }

    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  </style>
</head>
<body>

<header>
  <div class="header-btn" onclick="history.back()">
    <i data-lucide="arrow-left" width="20"></i>
  </div>
  <div class="header-title" id="headerTitle">Memuat...</div>
  <div class="header-btn">
    <i data-lucide="settings" width="20"></i> </div>
</header>

<div class="player-wrapper" id="playerWrapper">
  <iframe id="iframePlayer" class="player-frame" src="" 
          allowfullscreen 
          sandbox="allow-scripts allow-same-origin allow-presentation allow-forms"
          referrerpolicy="no-referrer">
  </iframe>

  <div class="gesture-layer">
    <div class="gesture-zone" id="zoneLeft"></div>
    <div class="gesture-zone" id="zoneMiddle"></div> <div class="gesture-zone" id="zoneRight"></div>
  </div>

  <div id="feedbackLeft" class="tap-feedback tap-left">
    <i data-lucide="rotate-ccw" width="16"></i> -5s
  </div>
  <div id="feedbackRight" class="tap-feedback tap-right">
    +5s <i data-lucide="rotate-cw" width="16"></i>
  </div>
</div>

<div class="content-body">
  
  <div class="main-info">
    <div class="series-title" id="epTitle">Memuat Judul...</div>
    <div class="meta-tags">
        <span id="sourceTag" style="color: var(--accent);">SOURCE</span> â€¢ 
        <span id="dateTag">Updating...</span>
    </div>
  </div>

  <div class="nav-controls">
    <button id="btnPrev" class="nav-btn" disabled>
        <i data-lucide="skip-back" width="18"></i> Prev
    </button>
    <button id="btnNext" class="nav-btn" disabled>
        Next <i data-lucide="skip-forward" width="18"></i>
    </button>
  </div>

  <a href="https://whatsapp.com/channel/0029Vb6kx8FFi8xZBhjm2g0m" target="_blank" class="wa-btn">
    <i data-lucide="message-circle" width="24" fill="currentColor"></i>
    Gabung Saluran WhatsApp
  </a>

  <div class="server-box">
    <div class="server-header" onclick="toggleServerList()">
        <div style="display:flex; flex-direction:column;">
            <span style="font-size:0.65rem; color:var(--text-muted);">SERVER STREAMING</span>
            <span class="server-current" id="currentServerName">PILIH SERVER</span>
        </div>
        <i data-lucide="chevron-down" id="srvIcon"></i>
    </div>
    <div class="server-list" id="serverList">
        <div style="padding:10px; text-align:center; color:#666;">Memuat...</div>
    </div>
  </div>

  <div class="dl-toggle" onclick="toggleDl()">
    <i data-lucide="download" width="14" style="vertical-align:middle;"></i> Tampilkan Link Download
  </div>
  <div class="dl-area" id="dlContainer"></div>

</div>

<div id="toast" class="toast">Notifikasi</div>

<script>
    // =========================================
    // 1. CONFIG & API
    // =========================================
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    const API_ANIME   = "https://www.sankavollerei.com/anime/samehadaku"; // Proxy API

    const urlParams = new URLSearchParams(window.location.search);
    const donghuaUrl = urlParams.get('url');
    const animeId = urlParams.get('id');
    let source = urlParams.get('source');

    // Auto detect source
    if (!source) {
        if (animeId) source = 'anime';
        else if (donghuaUrl) source = 'donghua';
    }

    // =========================================
    // 2. HELPER FUNCTIONS
    // =========================================
    // Smart Fetch untuk handle CORS/Proxy
    async function smartFetch(url) {
        const proxies = [
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
        ];
        
        try { const res = await fetch(url); if(res.ok) return await res.json(); } catch(e){}
        for (const p of proxies) {
            try { const res = await fetch(p(url)); if(res.ok) return await res.json(); } catch(e){}
        }
        throw new Error("Gagal koneksi API");
    }

    // Bersihkan nama server (Hanya Huruf Angka)
    function cleanServerName(name) {
        return name.replace(/[^a-zA-Z0-9 ]/g, "").trim().toUpperCase();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // =========================================
    // 3. UI INTERACTION
    // =========================================
    function toggleServerList() {
        const list = document.getElementById('serverList');
        const icon = document.getElementById('srvIcon');
        list.classList.toggle('show');
        icon.style.transform = list.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function toggleDl() {
        const dl = document.getElementById('dlContainer');
        dl.style.display = dl.style.display === 'block' ? 'none' : 'block';
    }

    // GESTURE LOGIC (Visual Only karena Iframe limitation)
    let lastTap = 0;
    
    function setupGestures() {
        // Double tap right
        document.getElementById('zoneRight').addEventListener('click', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                showGestureFeedback('right');
                // Note: Kita tidak bisa seek iframe cross-origin, 
                // ini hanya feedback visual agar user merasa "canggih"
            }
            lastTap = currentTime;
        });

        // Double tap left
        document.getElementById('zoneLeft').addEventListener('click', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                showGestureFeedback('left');
            }
            lastTap = currentTime;
        });
        
        // Klik tengah untuk hide/show header (Optional)
        document.getElementById('zoneMiddle').addEventListener('click', () => {
             // Pass through click is hard with overlays, 
             // so we usually hide overlay briefly or let pointer-events handle it
             const header = document.querySelector('.header-title');
             header.style.opacity = header.style.opacity === '1' ? '0' : '1';
        });
    }

    function showGestureFeedback(side) {
        const el = document.getElementById(side === 'left' ? 'feedbackLeft' : 'feedbackRight');
        el.style.animation = 'none';
        el.offsetHeight; /* trigger reflow */
        el.style.animation = 'ripple 0.6s linear';
        showToast(side === 'left' ? 'Mundur 5 Detik' : 'Maju 5 Detik');
    }

    // =========================================
    // 4. MAIN LOAD LOGIC
    // =========================================
    async function loadData() {
        try {
            document.getElementById('sourceTag').innerText = source === 'anime' ? "ANIME" : "DONGHUA";
            
            let data = {};
            
            if (source === 'anime' && animeId) {
                const cleanID = animeId.replace(/\/$/, '').split('/').pop();
                const json = await smartFetch(`${API_ANIME}/episode/${cleanID}`);
                const d = json.data;
                if(!d) throw new Error("Data Kosong");

                data = {
                    title: d.title,
                    stream: d.defaultStreamingUrl,
                    servers: d.server?.qualities || [],
                    prev: d.hasPrevEpisode ? `stream.html?id=${d.prevEpisode.episodeId}&source=anime` : null,
                    next: d.hasNextEpisode ? `stream.html?id=${d.nextEpisode.episodeId}&source=anime` : null,
                    downloads: d.downloadUrl?.formats
                };

                renderAnimeServers(data.servers);

            } else if (donghuaUrl) {
                const res = await smartFetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(donghuaUrl)}`);
                
                data = {
                    title: res.episode,
                    stream: res.streaming?.main_url?.url,
                    servers: res.streaming?.servers || [],
                    prev: res.navigation?.previous_episode?.anichinUrl ? `stream.html?url=${encodeURIComponent(res.navigation.previous_episode.anichinUrl)}&source=donghua` : null,
                    next: res.navigation?.next_episode?.anichinUrl ? `stream.html?url=${encodeURIComponent(res.navigation.next_episode.anichinUrl)}&source=donghua` : null,
                    downloads: res.download_url
                };

                renderDonghuaServers(data.servers);
            }

            // Update UI
            document.getElementById('epTitle').innerText = data.title;
            document.getElementById('headerTitle').innerText = data.title; // Judul di header
            document.getElementById('dateTag').innerText = new Date().toLocaleDateString();

            if(data.stream) {
                document.getElementById('iframePlayer').src = data.stream;
            }

            // Nav Buttons
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            
            if(data.prev) { btnPrev.disabled = false; btnPrev.onclick = () => location.href = data.prev; }
            if(data.next) { btnNext.disabled = false; btnNext.onclick = () => location.href = data.next; }

            saveHistory(data.title);
            renderDownloads(data.downloads);

        } catch (e) {
            console.error(e);
            showToast("Gagal memuat video");
        }
    }

    // =========================================
    // 5. RENDERERS
    // =========================================
    function renderAnimeServers(list) {
        const container = document.getElementById('serverList');
        let html = '';
        
        // Add Default
        html += `<div class="srv-item active" onclick="changeServer(null, 'DEFAULT', this)">DEFAULT</div>`;

        list.forEach(group => {
            (group.serverList || []).forEach(srv => {
                const cleanName = cleanServerName(srv.title);
                html += `<div class="srv-item" onclick="changeAnimeServer('${srv.serverId}', '${cleanName}', this)">${cleanName}</div>`;
            });
        });
        container.innerHTML = html;
    }

    function renderDonghuaServers(list) {
        const container = document.getElementById('serverList');
        let html = '';
        
        list.forEach((srv, index) => {
            const cleanName = cleanServerName(srv.name);
            const activeClass = index === 0 ? 'active' : ''; // Default active logic simplified
            html += `<div class="srv-item ${activeClass}" onclick="changeServer('${srv.url}', '${cleanName}', this)">${cleanName}</div>`;
        });
        container.innerHTML = html;
    }

    async function changeAnimeServer(id, name, btn) {
        btn.innerText = "LOADING...";
        try {
            const json = await smartFetch(`${API_ANIME}/server/${id}`);
            const url = json.data?.url || json.url;
            if(url) {
                changeServer(url, name, btn);
            } else {
                showToast("Server Error");
                btn.innerText = name;
            }
        } catch(e) {
            btn.innerText = name;
        }
    }

    function changeServer(url, name, btn) {
        if(url) document.getElementById('iframePlayer').src = url;
        else location.reload(); // Default reload for default server

        // UI Update
        document.querySelectorAll('.srv-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        btn.innerText = name; // Restore name if changed
        document.getElementById('currentServerName').innerText = name;
        
        toggleServerList(); // Close dropdown
        showToast("Server: " + name);
    }

    function renderDownloads(data) {
        const box = document.getElementById('dlContainer');
        if(!data) { box.innerHTML = "<p style='color:#666;text-align:center;'>Tidak tersedia</p>"; return; }
        
        let html = "";
        // Simplifikasi render download logic (bisa disesuaikan dengan struktur data)
        if(Array.isArray(data)) { // Anime Structure
             data.forEach(f => {
                (f.qualities || []).forEach(q => {
                    (q.urls || []).forEach(u => {
                        html += `<a href="${u.url}" target="_blank" class="dl-link">${f.title} - ${q.title} (${u.title})</a>`;
                    });
                });
             });
        } else { // Donghua Structure
             for(let [k,v] of Object.entries(data)) {
                 for(let [p, u] of Object.entries(v)) {
                     html += `<a href="${u}" target="_blank" class="dl-link">${k} - ${p}</a>`;
                 }
             }
        }
        box.innerHTML = html;
    }

    function saveHistory(title) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        const key = source === 'anime' ? animeId : donghuaUrl;
        hist = hist.filter(h => h.url !== key);
        hist.unshift({
            title: title, url: key, source: source,
            date: new Date().toLocaleDateString()
        });
        localStorage.setItem('my_history', JSON.stringify(hist.slice(0, 20)));
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        setupGestures();
        loadData();
    });

</script>
</body>
</html>
