<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>RayStream Player</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --bg-dark: #000000;
      --bg-panel: #0f0f11;
      --primary: #6366f1;
      --accent: #8b5cf6;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --wa-color: #25D366;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Outfit', sans-serif; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-panel);
      color: var(--text-main);
      overflow-x: hidden;
      padding-bottom: 60px;
    }

    /* --- HEADER (Floating) --- */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 15px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
      pointer-events: none;
    }
    
    .header-btn {
      pointer-events: auto;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: white;
      transition: 0.2s;
    }
    .header-btn:active { transform: scale(0.9); }

    .header-title {
      font-size: 0.9rem; font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 60%;
      opacity: 0; transition: 0.3s;
    }

    /* --- PLAYER AREA --- */
    .player-wrapper {
      position: sticky; top: 0; z-index: 50;
      width: 100%;
      background: #000;
      padding-top: 56.25%; /* 16:9 Aspect Ratio */
    }

    .player-frame {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      border: none; z-index: 1;
    }

    /* Gesture Overlay (Visual Feedback Only) */
    .gesture-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 2; display: flex; pointer-events: none; /* Biar bisa klik video */
    }
    
    /* Area tap manual (Invisible) */
    .tap-area {
        position: absolute; top: 0; height: 100%; width: 20%;
        z-index: 20; cursor: pointer;
    }
    .tap-left { left: 0; }
    .tap-right { right: 0; }

    /* Animasi Tap */
    .tap-feedback {
      position: absolute; top: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7); color: white;
      padding: 10px 20px; border-radius: 30px;
      font-size: 0.8rem; font-weight: 700;
      display: flex; align-items: center; gap: 5px;
      opacity: 0; pointer-events: none; z-index: 30;
      backdrop-filter: blur(4px);
    }
    .fb-left { left: 20%; }
    .fb-right { left: 80%; }
    
    @keyframes ripple { 
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
    }

    /* --- CONTENT BODY --- */
    .content-body {
      padding: 20px;
      background: var(--bg-panel);
      position: relative; z-index: 60;
      box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
      border-radius: 24px 24px 0 0;
      margin-top: -15px; /* Overlap effect */
    }

    .ep-title {
      font-size: 1.1rem; font-weight: 700; line-height: 1.4;
      margin-bottom: 8px;
    }
    
    .ep-meta {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.75rem; color: var(--text-muted);
      margin-bottom: 20px;
    }
    
    .badge {
      padding: 3px 8px; border-radius: 6px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .badge-src { background: var(--primary); color: #fff; }

    /* Nav Buttons */
    .nav-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
      margin-bottom: 25px;
    }
    .btn-nav {
      background: #18181b; color: #fff; border: 1px solid rgba(255,255,255,0.1);
      padding: 12px; border-radius: 12px; font-weight: 600; font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; transition: 0.2s;
    }
    .btn-nav:active { transform: scale(0.97); background: #27272a; }
    .btn-nav:disabled { opacity: 0.4; pointer-events: none; }

    /* WA Button */
    .btn-wa {
      background: var(--wa-color); color: #fff;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%; padding: 14px; border-radius: 16px;
      font-weight: 700; text-decoration: none; margin-bottom: 25px;
      box-shadow: 0 5px 20px rgba(37, 211, 102, 0.2);
    }
    .btn-wa:active { transform: scale(0.98); }

    /* Server Dropdown Box */
    .server-box {
      background: #18181b; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px; overflow: hidden; margin-bottom: 20px;
    }
    .server-head {
      padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; background: rgba(255,255,255,0.02);
    }
    .server-current { color: var(--primary); font-weight: 700; text-transform: uppercase; }
    
    .server-grid {
      display: none; padding: 15px; gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      background: #141416; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .server-grid.show { display: grid; }
    
    .btn-srv {
      background: rgba(255,255,255,0.05); border: none;
      padding: 10px 5px; border-radius: 8px; color: #d1d5db;
      font-size: 0.75rem; font-weight: 600; cursor: pointer;
      text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .btn-srv.active { background: var(--primary); color: #fff; }

    /* Download List */
    .dl-section {
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 20px;
    }
    .dl-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; color: var(--text-muted); }
    .dl-item {
      background: #18181b; padding: 12px; border-radius: 12px; margin-bottom: 8px;
    }
    .dl-res { font-size: 0.8rem; font-weight: 700; color: #fff; margin-bottom: 8px; }
    .dl-links { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-dl {
      background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 6px;
      font-size: 0.7rem; color: #fff; text-decoration: none;
    }

    /* Toast */
    #toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: rgba(20, 20, 22, 0.95); padding: 10px 20px; border-radius: 30px;
      color: white; font-size: 0.85rem; z-index: 200; opacity: 0; pointer-events: none;
      transition: 0.3s; border: 1px solid rgba(255,255,255,0.1);
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<header>
  <div class="header-btn" onclick="history.back()">
    <i data-lucide="arrow-left" width="20"></i>
  </div>
  <div class="header-title" id="headerTitle">Memuat...</div>
  <div class="header-btn">
    <i data-lucide="settings" width="20"></i>
  </div>
</header>

<div class="player-wrapper">
    <iframe id="iframePlayer" class="player-frame" src="" allowfullscreen allow="autoplay; encrypted-media"></iframe>

    <div class="tap-area tap-left" id="zoneLeft"></div>
    <div class="tap-area tap-right" id="zoneRight"></div>

    <div id="fbLeft" class="tap-feedback fb-left">
        <i data-lucide="rotate-ccw" width="16"></i> -10s
    </div>
    <div id="fbRight" class="tap-feedback fb-right">
        +10s <i data-lucide="rotate-cw" width="16"></i>
    </div>
</div>

<div class="content-body">
    
    <div class="ep-title" id="epTitle">Memuat Data...</div>
    <div class="ep-meta">
        <span class="badge badge-src" id="srcBadge">DONGHUA</span>
        <span id="dateInfo">Updated Today</span>
    </div>

    <div class="nav-row">
        <button id="btnPrev" class="btn-nav" disabled>
            <i data-lucide="skip-back" width="18"></i> Prev
        </button>
        <button id="btnNext" class="btn-nav" disabled>
            Next <i data-lucide="skip-forward" width="18"></i>
        </button>
    </div>

    <a href="https://whatsapp.com/channel/0029Vb6kx8FFi8xZBhjm2g0m" target="_blank" class="btn-wa">
        <i data-lucide="message-circle" width="22" fill="white"></i>
        Gabung Saluran WhatsApp
    </a>

    <div class="server-box">
        <div class="server-head" onclick="toggleServers()">
            <div>
                <div style="font-size:0.65rem; color:#666;">SERVER PLAYER</div>
                <div class="server-current" id="serverName">DEFAULT</div>
            </div>
            <i data-lucide="chevron-down" id="srvIcon" style="transition:0.3s"></i>
        </div>
        <div class="server-grid" id="serverGrid">
            </div>
    </div>

    <div class="dl-section" id="dlSection" style="display:none;">
        <div class="dl-title"><i data-lucide="download" width="14" style="vertical-align:middle"></i> LINK DOWNLOAD</div>
        <div id="dlContainer"></div>
    </div>

</div>

<div id="toast">Notifikasi</div>

<script>
    // ===================================
    // CONFIG
    // ===================================
    const API_DONGHUA = "https://anichin-seven.vercel.app/api";
    // Proxy (opsional jika Anichin butuh)
    const PROXY = "https://corsproxy.io/?"; 
    
    const urlParams = new URLSearchParams(window.location.search);
    const donghuaUrl = urlParams.get('url');
    const animeId = urlParams.get('id'); // Fallback jika anime
    
    // ===================================
    // MAIN LOGIC
    // ===================================
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        initGestures();

        if(donghuaUrl) {
            loadDonghua(donghuaUrl);
        } else if (animeId) {
            // Logic Anime (Existing)
            document.getElementById('epTitle').innerText = "Mode Anime belum diupdate untuk V2";
        } else {
            document.getElementById('epTitle').innerText = "URL Tidak Valid";
        }
    });

    async function loadDonghua(url) {
        try {
            // Panggil API Detail
            const res = await fetch(`${API_DONGHUA}/detail?url=${encodeURIComponent(url)}`);
            const json = await res.json();
            
            if(!json || !json.streaming) throw new Error("Data stream tidak ditemukan");

            // 1. Set Title
            document.getElementById('epTitle').innerText = json.episode;
            document.getElementById('headerTitle').innerText = json.episode;
            saveHistory(json.episode, url);

            // 2. Load Player Utama
            const mainStream = json.streaming.main_url.url;
            const mainName = cleanName(json.streaming.main_url.name || "PREMIUM");
            
            loadPlayer(mainStream);
            updateServerLabel(mainName);

            // 3. Render List Server
            renderServers(json.streaming.servers, mainStream);

            // 4. Render Downloads
            renderDownloads(json.download_url);

            // 5. Navigation Links
            setupNav(json.navigation);

        } catch (e) {
            console.error(e);
            showToast("Gagal memuat data: " + e.message);
        }
    }

    // ===================================
    // PLAYER & SERVER
    // ===================================
    function loadPlayer(url) {
        const frame = document.getElementById('iframePlayer');
        // Reset src untuk trigger reload
        frame.src = "about:blank";
        setTimeout(() => {
            frame.src = url;
        }, 100);
    }

    function renderServers(servers, currentUrl) {
        const grid = document.getElementById('serverGrid');
        grid.innerHTML = "";

        servers.forEach(srv => {
            const name = cleanName(srv.name);
            const btn = document.createElement('div');
            btn.className = `btn-srv ${srv.url === currentUrl ? 'active' : ''}`;
            btn.innerText = name;
            btn.onclick = () => {
                // Switch Server
                loadPlayer(srv.url);
                updateServerLabel(name);
                
                // Update Active UI
                document.querySelectorAll('.btn-srv').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                toggleServers(); // Tutup dropdown
                showToast(`Server: ${name}`);
            };
            grid.appendChild(btn);
        });
    }

    function cleanName(str) {
        // Hapus [Ads], emoji, dll, ambil huruf & angka saja
        return str.replace(/\[.*?\]/g, '').replace(/[^a-zA-Z0-9 ]/g, '').trim().toUpperCase();
    }

    function updateServerLabel(name) {
        document.getElementById('serverName').innerText = name;
    }

    function toggleServers() {
        const grid = document.getElementById('serverGrid');
        const icon = document.getElementById('srvIcon');
        grid.classList.toggle('show');
        icon.style.transform = grid.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    // ===================================
    // DOWNLOADS
    // ===================================
    function renderDownloads(urls) {
        const container = document.getElementById('dlContainer');
        const section = document.getElementById('dlSection');
        
        if(!urls || Object.keys(urls).length === 0) return;

        section.style.display = 'block';
        let html = "";

        // Loop Resolusi (download_url_360p, dll)
        for (const [key, providers] of Object.entries(urls)) {
            const res = key.replace('download_url_', '').toUpperCase(); // 360P
            
            html += `<div class="dl-item">
                <div class="dl-res">${res}</div>
                <div class="dl-links">`;
            
            // Loop Provider (Mirrored, Terabox, dll)
            for (const [pName, pUrl] of Object.entries(providers)) {
                html += `<a href="${pUrl}" target="_blank" class="btn-dl">${pName}</a>`;
            }
            html += `</div></div>`;
        }
        container.innerHTML = html;
    }

    // ===================================
    // NAVIGATION
    // ===================================
    function setupNav(nav) {
        const prev = document.getElementById('btnPrev');
        const next = document.getElementById('btnNext');

        if (nav.previous_episode && nav.previous_episode.anichinUrl) {
            prev.disabled = false;
            prev.onclick = () => {
                window.location.href = `stream.html?url=${encodeURIComponent(nav.previous_episode.anichinUrl)}&source=donghua`;
            };
        }

        if (nav.next_episode && nav.next_episode.anichinUrl) {
            next.disabled = false;
            next.onclick = () => {
                window.location.href = `stream.html?url=${encodeURIComponent(nav.next_episode.anichinUrl)}&source=donghua`;
            };
        }
    }

    // ===================================
    // GESTURES (Double Tap)
    // ===================================
    let lastTapLeft = 0;
    let lastTapRight = 0;

    function initGestures() {
        document.getElementById('zoneLeft').addEventListener('click', () => {
            const now = new Date().getTime();
            if (now - lastTapLeft < 300) {
                showFeedback('left');
                // Tidak bisa seek iframe, cuma visual
            }
            lastTapLeft = now;
        });

        document.getElementById('zoneRight').addEventListener('click', () => {
            const now = new Date().getTime();
            if (now - lastTapRight < 300) {
                showFeedback('right');
            }
            lastTapRight = now;
        });
    }

    function showFeedback(side) {
        const el = document.getElementById(side === 'left' ? 'fbLeft' : 'fbRight');
        el.style.animation = 'none';
        el.offsetHeight; /* Trigger Reflow */
        el.style.animation = 'ripple 0.6s ease-out';
        showToast(side === 'left' ? 'Mundur (Visual)' : 'Maju (Visual)');
    }

    // ===================================
    // UTILS
    // ===================================
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function saveHistory(title, url) {
        let hist = JSON.parse(localStorage.getItem('my_history')) || [];
        hist = hist.filter(h => h.url !== url);
        hist.unshift({
            title: title,
            url: url,
            source: 'donghua',
            date: new Date().toLocaleDateString()
        });
        localStorage.setItem('my_history', JSON.stringify(hist.slice(0, 20)));
    }
</script>
</body>
</html>
